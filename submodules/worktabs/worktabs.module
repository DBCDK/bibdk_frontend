<?php

module_load_include('inc', 'worktabs', 'worktabs.field');

/**
 * Implements hook_theme().
 */
function worktabs_theme($existing, $type, $theme, $path) {
  return array(
    'worktabs' => array(
      'template' => 'theme/worktabs',
      'variables' => array(
        'pid' => '',
        'tabs' => array(),
      ),
    ),
    'tab-item' => array(
      'render element' => 'content',
      'template' => 'theme/tab_item',
      'variables' => array(
        'title' => '',
        'btn_txt_closed' => '',
        'btn_txt_open' => '',
        'single' => FALSE,
        'content' => '',
      ),
    ),
  );
}

/**
 * Implements hook_elemenent_info().
 */
function worktabs_element_info() {
  return array(
    'worktabs' => array(
      '#pre_render' => array('worktabs_pre_render'),
      '#theme' => 'worktabs',
    ),
    'tab-item' => array(
      '#pre_render' => array('worktabs_pre_render'),
      '#theme' => 'worktabs',
    ),
  );
}

function worktabs_pre_render($elements) {
  $pre_render_elements = array('title', 'content', 'btn_txt_closed', 'btn_txt_open');

  foreach ($elements['#tabs'] as $type => $tab) {
    foreach ($pre_render_elements as $pre) {
      $elements['#tabs'][$type][$pre] = render($tab[$pre]);
    }
  }

  return $elements;
}

/**
 * Main function for the worktabs.
 * Has the bibdkWork entity as paramter, which is passed along to modules
 * implementing the hook_worktabs_items()
 *
 * @param BibdkWork $entity
 * @return string
 *
 * @see theme/worktabs.tpl.php
 */
function worktabs_get_tabs($entity) {
  $content = array();
  $tabs['#tabs'] = worktabs_get_content($content, $entity);
  $tabs['#pid'] = _worktabs_trim_string($entity->id);
  drupal_add_js(drupal_get_path('module', 'worktabs') . '/js/worktabs.js');
  $tabs['#type'] = 'worktabs';
  return $tabs;
}

/**
 * Invokes the hook_worktabs_items() to retrive content for the tabs provided
 * by other modules.
 *
 * @param $tabs
 * @param $entity
 * @return array
 */
function worktabs_get_content($tabs, $entity) {
  $content = module_invoke_all('worktabs_items', $tabs, $entity);
  $return = worktabs_merge_content($content);
  return $return;
}

/**
 * Merges the cotent retreived with the outer tabs
 *
 * @param $content
 * @internal param array $tabs
 * @return array
 */
function worktabs_merge_content($content) {
    $default = array(
      '#btn_txt_closed' => t('view_more', array(), array('context' => 'worktab')),
      '#btn_txt_open' => t('view_less', array(), array('context' => 'worktabs')),
      '#theme' => 'tab-item',
    );
  $outertabs = worktabs_get_outer();
  foreach ($content as $tab => $inner) {
    foreach ($inner as &$element) {
      $element += $default;
      $element['#single'] = count($inner) < 2;
    }
    uasort($inner, 'drupal_sort_weight');
    $outertabs[$tab]['content'] = $inner;
  }

  return $outertabs;
}

/**
 * Generates the outer tabs with no content
 *
 * @return array
 */
function worktabs_get_outer() {
  return array(
    'subjects' => array(
      'title' => array(
        '#type' => 'translatable',
        '#translate' => 'Subjects',
      ),
      'content' => array(),
      'class' => 'active',
      'active' => 'active',
    ),
    'more-about' => array(
      'title' => array(
        '#type' => 'translatable',
        '#translate' => 'More Info',
      ),
      'content' => array(),
      'class' => '',
      'active' => 'visuallyhidden',
    ),
    'reviews' => array(
      'title' => array(
        '#type' => 'translatable',
        '#translate' => 'Reviews',
      ),
      'content' => array(),
      'class' => '',
      'active' => 'visuallyhidden',
    ),
  );
}

/**
 * Strips a string (pid) for :, -, __
 *
 * @param string $string
 * @return string
 */
function _worktabs_trim_string($string) {
  return strtolower(strtr($string, array(':' => '_', '-' => '_')));
}
